<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a routerLink="/list-pov" class="btn btn-secondary">‚¨ÖÔ∏è Retour</a>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="principal">üìç Point de vente : {{ povData?.name }}</h2>
    <a routerLink="/form-pov/{{ povData?.id }}" class="button principal">Modifier le point de vente</a>
  </div>

  <div class="mb-4">
    <p><strong>üí∞ Caisse :</strong> {{ povData?.caisse.montant_total | number:'1.0-0' }} Fbu</p>
    <p><strong>üë§ Responsable :</strong> {{ povData?.responsable?.user?.first_name }} {{ povData?.responsable?.user?.last_name }}</p>
  </div>

  <div class="mb-5">
    <h4 class="principal">üì¶ Produits en stock</h4>

    <table class="table table-hover">
      <thead>
        <tr>
          <th>Produits</th>
          <th>Date d'expiration</th>
          @if (userData?.role_display === 'gerant') {
            <th>Prix d'achat</th>
          }
          <th>Prix de vente</th>
          <th>En stock</th>
          @if (userData?.role_display === 'gerant') {
            <th>Gain potentiel</th>
            <th>Action</th>
          }
        </tr>
      </thead>

      <tbody>
        @for (product of povData?.stocks; track product.id) {
          <tr>
            <td>{{ product.produit_nom }}</td>
            <td>{{ product.date_expiration | date:'dd MMM yyyy' }}</td>
            @if (userData?.role_display === 'gerant') {
              <td>{{ product.prix_achat | number:'1.0-0' }} Fbu</td>
            }
            <td>{{ product.prix_vente | number:'1.0-0' }} Fbu</td>
            <td>{{ product.quantite }} box</td>
            @if (userData?.role_display === 'gerant') {
              <td>{{ product.quantite * product.prix_vente | number:'1.0-0' }} Fbu</td>
              <td>
                <button
                  class="btn btn-sm btn-warning me-2"
                  data-bs-toggle="modal"
                  data-bs-target="#modalRediriger"
                  (click)="selectedProduct = product">
                  Rediriger
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#modalDefectueux"
                  (click)="selectedProduct = product">
                  Retirer (d√©fectueux)
                </button>
              </td>
            }
          </tr>
        }

        @if (userData?.role_display === 'gerant') {
          <tr class="fw-bold">
            <td colspan="5" class="text-end">Total rendement attendu :</td>
            <td colspan="2">{{ totalRendementAttendu | number:'1.0-0' }} Fbu</td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- üîÅ Modal Rediriger -->
   <form [formGroup]="deliverForm" (ngSubmit)="redirigerProduit(selectedProduct)">
  <div class="modal fade" id="modalRediriger" tabindex="-1" aria-labelledby="modalRedirigerLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Rediriger le produit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
              <label for="povDestination" class="form-label">Point de vente destination</label>
              <select
                id="povDestination"
                class="form-select"
                name="povDestination"
                formControlName="pov">
                @for (pov of listPov; track pov.id) {
                  <option [value]="pov.id">{{ pov.nom }}</option>
                }
              </select>
            </div>
            <div class="mb-3">
              <label for="quantiteRedirigee" class="form-label">Quantit√© √† rediriger</label>
              <input
                type="number"
                min="1"
                class="form-control"
                id="quantiteRedirigee"
                formControlName="quantite"
                name="quantiteRedirigee">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-warning" [disabled]="deliverForm.invalid || isLoading">
            @if(isLoading) {
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            }@else {
              <span>‚úÖ</span>
            }
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

  <!-- üîß Modal D√©fectueux -->
   <form [formGroup]="defectueuxForm" (ngSubmit)="retirerDefectueux(selectedProduct)">
  <div class="modal fade" id="modalDefectueux" tabindex="-1" aria-labelledby="modalDefectueuxLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Retirer comme d√©fectueux</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
              <label for="quantiteDefectueuse" class="form-label">Quantit√© d√©fectueuse</label>
              <input
                type="number"
                min="1"
                class="form-control"
                id="quantiteDefectueuse"
                formControlName="quantite"
                name="quantiteDefectueuse">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-danger" [disabled]="defectueuxForm.invalid || isLoading">
            @if(isLoading) {
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            }@else {
              <span>‚úÖ</span>
            }
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>
</form>
</div>
