<div class="container mt-4">
  <h2 class="mb-3 text-principal">ðŸ“¦ Distributeurs & Produits</h2>

  <div class="container text-center mb-3">
    <div class="row">
      <div class="col">
        <button type="button" class="btn btn-primary rounded-pill m-1 p-1" data-bs-toggle="modal" data-bs-target="#createDistributeur" (click)="openCreateModal()">
          + Add
        </button>
      </div>
    </div>

    <div class="row text-start gap-1">
      @if (loading) {
        loading...
      } @else {
        @if (distributeurs && distributeurs.length > 0) {
          <div class="accordion" id="accordionUsers">
            @for (dist of distributeurs; track $index) {
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#collapse' + $index" aria-expanded="false" aria-controls="collapse">
                    <div class="d-flex align-items-center justify-content-between">
                      <h2>{{ dist.nom }}</h2>
                      <div>
                        <button type="button" class="btn btn-sm btn-warning m-2" data-bs-toggle="modal" data-bs-target="#createDistributeur" (click)="openEditModal(dist)">Modifier</button>
                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" [attr.data-bs-target]="'#deleteConfirm' + $index">Supprimer</button>
                      </div>
                    </div>
                  </button>
                </h2>
                <div [attr.id]="'collapse' + $index" class="accordion-collapse collapse">
                  <div class="m-2">
                    Contact:
                    <span class="text-secondary">{{ dist.telephone }}, {{ dist.adress }}</span>
                  </div>
                  <div class="m-2">
                    <h5>Produits</h5>
                    @if(!isAchatMode){
                    <button type="button" class="btn btn-sm btn-primary m-2" (click)="faireAchat()">
                      Faire un achat
                    </button>}
                    @if (isAchatMode) {
                      <app-list-achat
                      [data]="dist.produits"
                      [columns]="[
                        { key: 'nom', label: 'Nom' },
                        { key: 'description', label: 'Description' }
                      ]"
                      (achat)="listAchat($event)">
                    </app-list-achat>
                    <button type="button"
                            class="btn btn-sm btn-success m-2"
                            data-bs-toggle="modal"
                            data-bs-target="#achatModal"
                            [disabled]="listeAchat.length === 0">
                      Finaliser l'achat
                    </button>
                    }@else {
                      <app-list
                        [data]="dist.produits"
                        [columns]="[
                          { key: 'nom', label: 'Nom' },
                          { key: 'description', label: 'Description' }
                        ]"
                        (edit)="modifier($event)"
                        (delete)="supprimerProduit($event)">
                      </app-list>

                    <button type="button" class="btn btn-warning rounded-pill m-1 p-1" data-bs-toggle="modal" [attr.data-bs-target]="'#createProduct' + $index">
                      + add
                    </button>
                    }
                  </div>
                </div>
              </div>

              <!-- Modal: Ajouter produit -->
              <div class="modal fade" [attr.id]="'createProduct' + $index" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="exampleModalLabel">Create Product</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form [formGroup]="productForm" (ngSubmit)="submitAllProducts(dist.id)">
                        <div formArrayName="products">
                          @for (productGroup of products.controls; track $index) {
                            <div [formGroupName]="$index" class="border rounded p-3 mb-2">
                              <h6>Produit {{ $index + 1 }}</h6>

                              <div class="mb-2">
                                <input type="text" class="form-control" formControlName="name" placeholder="Nom du produit" required />
                              </div>

                              <div class="mb-2">
                                <input type="text" class="form-control" formControlName="description" placeholder="Description" required />
                              </div>
                            </div>
                          }
                        </div>

                        <div class="d-flex justify-content-between mt-3">
                          <button type="button" class="btn btn-outline-primary" (click)="addProduct()">
                            âž• Ajouter plusieurs produits
                          </button>

                          <button type="button" class="btn btn-outline-danger" (click)="deleteProduct($index)">
                            Supprimer une ligne
                          </button>

                          <button type="submit" class="btn btn-success" [disabled]="products.length === 0 || isLoading">
                            @if (isLoading) {
                              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            } @else {
                              <span>âœ…</span>
                            }
                            ðŸŸ¢ CrÃ©er
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal: Confirmation de suppression -->
              <div class="modal fade" [attr.id]="'deleteConfirm' + $index" tabindex="-1" aria-labelledby="deleteLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="deleteLabel">Confirmation</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    <div class="modal-body">
                      Voulez-vous vraiment supprimer ce distributeur ?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal" (click)="supprimer(dist.id)" [disabled]="isLoading">
                        @if (isLoading) { Suppression... } @else { Supprimer }
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Fin modal suppression -->
            
           <!-- Modal pour finaliser l'achat -->
            <!-- Modal -->
            <div class="modal fade" id="achatModal" tabindex="-1" aria-labelledby="achatModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">

                  <div class="modal-header">
                    <h5 class="modal-title" id="achatModalLabel">Finaliser l'achat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                  </div>
                <form [formGroup]="achatForm" (ngSubmit)="validerAchat(dist.id)">
                  <div class="modal-body">

                    <!-- Liste des produits -->
                    <h6>Produits sÃ©lectionnÃ©s :</h6>
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>Nom</th>
                            <th>Description</th>
                            <th>QuantitÃ©</th>
                            <th>Prix d'achat (FBu)</th>
                            <th>Prix de vente (FBu)</th>
                            <th>Date d'expiration</th>
                            <th>Total (FBu)</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (produit of listeAchat; track $index) {
                            <tr>
                              <td>{{ produit.nom }}</td>
                              <td>{{ produit.description }}</td>
                              <td>{{ produit.quantite }}</td>
                              <td>{{ produit.prix_achat | number:'1.0-0' }}</td>
                              <td>{{ produit.prix_vente | number:'1.0-0' }}</td>
                              <td>
                                {{ produit.date_expiration ? (produit.date_expiration | date:'dd/MM/yyyy') : 'Non spÃ©cifiÃ©e' }}
                              </td>
                              <td>{{ (produit.quantite * produit.prix_achat) | number:'1.0-0' }}</td>
                              <td>
                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        aria-label="Retirer"
                                        (click)="retirerProduit(produit)">
                                  <i class="fa fa-trash"></i>
                                </button>
                              </td>
                            </tr>
                          }
                        </tbody>
                        <tfoot>
                          <tr class="table-secondary fw-bold">
                            <td colspan="6" class="text-end">Prix total :</td>
                            <td colspan="2">
                              {{ totalAchat | number:'1.0-0' }} FBu
                            </td>
                          </tr>
                        </tfoot>
                      </table>

                    <!-- SÃ©lection du point de vente -->

                    <div class="mb-3">
                      <label for="pointDeVenteSelect" class="form-label">Point de vente</label>
                      <select class="form-select" id="pointDeVenteSelect" formControlName="pointDeVente">
                        @for( pdv of pointsDeVente; track $index) {
                        <option [value]="pdv.id">{{ pdv.nom }}</option>
                        }
                      </select>
                    </div>

                    <!-- SÃ©lection de la caisse -->
                    <div class="mb-3">
                      <label for="caisseSelect" class="form-label">Caisse</label>
                      <select class="form-select" id="caisseSelect" formControlName="caisse">
                        @for( caisse of caisses; track $index) {
                        <option [value]="caisse.id">{{ caisse.montant_total | number:'1.0-0'  }} FBu</option>
                        }
                      </select>
                    </div>

                    <!-- Champ bordereau -->
                    <div class="mb-3">
                      <label for="bordereauInput" class="form-label">NumÃ©ro de bordereau</label>
                      <input type="text" class="form-control" id="bordereauInput" formControlName="bordereau" placeholder="Ex: BORD-00123">
                    </div>

                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" (click)="validerAchat(dist.id)" [disabled]="!achatForm.valid || isLoading">
                      @if (isLoading) {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                      } @else {
                        <span>âœ…</span>
                      }
                      Valider l'achat
                    </button>
                  </div>
                  </form>
                </div>
              </div>
            </div>
            }
          </div>
        } @else {
          <div class="container">
            <div class="row justify-content-center">
              <h3 class="text-center">Page vide</h3>
              <p class="text-center">Creez un distributeur en cliquant sur le bouton "+add"</p>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <div class="modal fade" id="createDistributeur" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">
            {{ isEditMode ? 'Modifier Distributeur' : 'CrÃ©er Distributeur' }}
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <form class="needs-validation" [formGroup]="distributeurForm" (ngSubmit)="onSubmit()" novalidate>
            <div class="mb-2">
              <label for="nameDistributeur" class="visually-hidden">Nom</label>
              <input type="text" class="form-control" formControlName="nom" id="nameDistributeur" placeholder="Nom distributeur" required>
            </div>
            <div class="mb-2">
              <label for="adress" class="visually-hidden">Adresse</label>
              <input type="text" class="form-control" formControlName="adress" id="adress" placeholder="Adresse" required>
            </div>
            <div class="mb-2">
              <label for="tel" class="visually-hidden">TÃ©lÃ©phone</label>
              <input type="text" class="form-control" formControlName="telephone" id="tel" placeholder="TÃ©lÃ©phone" required>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-primary w-100" [disabled]="!distributeurForm.valid || isLoading">
                @if (isLoading) {
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                } @else {
                  <span>âœ…</span>
                }
                {{ isEditMode ? 'Mettre Ã  jour' : 'CrÃ©er' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>



